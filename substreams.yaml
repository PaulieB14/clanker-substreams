specVersion: v0.1.0
package:
  name: clanker_substreams
  version: v0.2.0
  url: https://github.com/PaulieB14/clanker-substreams
  description: Index Clanker token launches and activity on Base
  image: ./clanker.jpeg

imports:
  database_change: https://github.com/streamingfast/substreams-sink-database-changes/releases/download/v4.0.0/substreams-sink-database-changes-v4.0.0.spkg
  eth: https://github.com/streamingfast/substreams-ethereum/releases/download/v0.11.1/substreams-ethereum-v0.11.1.spkg

protobuf:
  files:
    - clanker.proto
  importPaths:
    - ./proto
  excludePaths:
    - sf/substreams
    - google

binaries:
  default:
    type: wasm/rust-v1
    file: ./target/wasm32-unknown-unknown/release/clanker_substreams.wasm

network: base

params:
  map_clanker_events: "clanker_factory=0xe85a59c628f7d27878aceb4bf3b35733630083a9"

modules:
  # Extract all Clanker factory events (TokenCreated, etc.)
  - name: map_clanker_events
    kind: map
    initialBlock: 22520000  # Approximate Clanker v4 deployment on Base
    inputs:
      - params: string
      - source: sf.ethereum.type.v2.Block
    output:
      type: proto:clanker.v1.ClankerEvents

  # Store token registry for lookups
  - name: store_tokens
    kind: store
    updatePolicy: set
    valueType: proto:clanker.v1.Token
    inputs:
      - map: map_clanker_events

  # Map token transfers (ERC20) for Clanker tokens only
  - name: map_token_transfers
    kind: map
    initialBlock: 22520000
    inputs:
      - source: sf.ethereum.type.v2.Block
      - store: store_tokens
    output:
      type: proto:clanker.v1.TokenTransfers

  # Store transfer volume per token (accumulates BigInt)
  - name: store_token_volume
    kind: store
    updatePolicy: add
    valueType: bigint
    inputs:
      - map: map_token_transfers

  # Store transfer counts per token
  - name: store_token_transfer_counts
    kind: store
    updatePolicy: add
    valueType: int64
    inputs:
      - map: map_token_transfers

  # Store total fees claimed per creator
  - name: store_creator_fees
    kind: store
    updatePolicy: add
    valueType: bigint
    inputs:
      - map: map_clanker_events

  # Store tokens per creator (for counting)
  - name: store_creator_token_counts
    kind: store
    updatePolicy: add
    valueType: int64
    inputs:
      - map: map_clanker_events

  # Output to database sink
  - name: db_out
    kind: map
    initialBlock: 22520000
    inputs:
      - map: map_clanker_events
      - map: map_token_transfers
    output:
      type: proto:sf.substreams.sink.database.v1.DatabaseChanges
