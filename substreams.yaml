specVersion: v0.1.0
package:
  name: clanker_substreams
  version: v0.1.0
  description: Index Clanker token launches and activity on Base

imports:
  database_change: https://github.com/streamingfast/substreams-sink-database-changes/releases/download/v4.0.0/substreams-sink-database-changes-v4.0.0.spkg
  eth: https://github.com/streamingfast/substreams-ethereum/releases/download/v0.11.1/substreams-ethereum-v0.11.1.spkg

protobuf:
  files:
    - clanker.proto
  importPaths:
    - ./proto
  excludePaths:
    - sf/substreams
    - google

binaries:
  default:
    type: wasm/rust-v1
    file: ./target/wasm32-unknown-unknown/release/clanker_substreams.wasm

network: base

params:
  map_clanker_events: "clanker_factory=0x20dd04c17afd5c9a8b3f2cdacaa8ee7907385bef"

modules:
  # Extract all Clanker factory events (TokenCreated, etc.)
  - name: map_clanker_events
    kind: map
    initialBlock: 22520000  # Approximate Clanker v4 deployment on Base
    inputs:
      - params: string
      - source: sf.ethereum.type.v2.Block
    output:
      type: proto:clanker.v1.ClankerEvents

  # Store token registry for lookups
  - name: store_tokens
    kind: store
    updatePolicy: set
    valueType: proto:clanker.v1.Token
    inputs:
      - map: map_clanker_events

  # Map token transfers (ERC20) for Clanker tokens only
  - name: map_token_transfers
    kind: map
    initialBlock: 22520000
    inputs:
      - source: sf.ethereum.type.v2.Block
      - store: store_tokens
    output:
      type: proto:clanker.v1.TokenTransfers

  # Output to database sink
  - name: db_out
    kind: map
    initialBlock: 22520000
    inputs:
      - map: map_clanker_events
      - map: map_token_transfers
    output:
      type: proto:sf.substreams.sink.database.v1.DatabaseChanges
